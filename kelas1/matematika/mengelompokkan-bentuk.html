<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mengelompokkan Bentuk - Kelas 1 SD</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Varela Round', sans-serif;
            background-color: #f0fdfa; /* Teal tint */
            background-image: radial-gradient(#99f6e4 2px, transparent 2px);
            background-size: 24px 24px;
            overflow: hidden; /* Prevent scrolling while dragging */
            touch-action: none; /* Important for drag on mobile */
        }
        
        .font-title { font-family: 'Fredoka', sans-serif; }

        /* Bin Styles */
        .bin-container {
            transition: transform 0.2s, background-color 0.2s;
        }
        .bin-container.hovered {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.8);
            border-color: #f59e0b;
        }

        /* Draggable Item Styles */
        .draggable-item {
            cursor: grab;
            touch-action: none;
            transition: transform 0.1s;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        .draggable-item:active {
            cursor: grabbing;
            transform: scale(1.1);
            z-index: 50;
        }
        .draggable-item.correct {
            transform: scale(0);
            opacity: 0;
            transition: all 0.5s ease-in;
        }

        @keyframes bounce-in {
            0% { transform: scale(0); }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .shake { animation: shake 0.4s; }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="root" class="flex-grow h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. ASSETS & DATA ---

        const Shapes = {
            segitiga: ({color}) => <svg viewBox="0 0 100 100" className="w-full h-full"><polygon points="50,10 90,90 10,90" fill={color} stroke="white" strokeWidth="3" strokeLinejoin="round"/></svg>,
            segiempat: ({color}) => <svg viewBox="0 0 100 100" className="w-full h-full"><rect x="15" y="15" width="70" height="70" rx="8" fill={color} stroke="white" strokeWidth="3"/></svg>,
            lingkaran: ({color}) => <svg viewBox="0 0 100 100" className="w-full h-full"><circle cx="50" cy="50" r="40" fill={color} stroke="white" strokeWidth="3"/></svg>,
            persegipanjang: ({color}) => <svg viewBox="0 0 100 60" className="w-full h-full"><rect x="5" y="5" width="90" height="50" rx="8" fill={color} stroke="white" strokeWidth="3"/></svg>
        };

        const COLORS = ["#ef4444", "#3b82f6", "#22c55e", "#eab308", "#a855f7", "#f97316"];
        
        // Generator Level
        const generateLevels = () => {
            const levels = [];
            const shapeTypes = ['segitiga', 'segiempat', 'lingkaran', 'persegipanjang'];
            
            // 10 Level dengan kombinasi berbeda
            for(let i=0; i<10; i++) {
                // Tentukan 2 kategori bentuk untuk level ini
                let category1 = shapeTypes[i % 4];
                let category2 = shapeTypes[(i + 1) % 4];
                if (category1 === category2) category2 = shapeTypes[(i + 2) % 4]; // Ensure different

                const items = [];
                // Generate 3-5 items for cat 1
                // PERBAIKAN: Menambahkan ID level (i) ke dalam ID item agar unik setiap level
                for(let j=0; j<3; j++) items.push({ id: `l${i}-c1-${j}`, type: category1, color: COLORS[Math.floor(Math.random()*COLORS.length)] });
                // Generate 3-5 items for cat 2
                for(let j=0; j<3; j++) items.push({ id: `l${i}-c2-${j}`, type: category2, color: COLORS[Math.floor(Math.random()*COLORS.length)] });
                
                levels.push({
                    id: i+1,
                    bins: [category1, category2],
                    items: items.sort(() => Math.random() - 0.5),
                    instruction: `Pisahkan bentuk ${category1} dan ${category2}!`
                });
            }
            return levels;
        };

        // TTS Helper
        const speak = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID';
                window.speechSynthesis.speak(utterance);
            }
        };

        // --- 2. COMPONENTS ---

        // Komponen Benda yang bisa ditarik
        const DraggableItem = ({ item, onDrop, containerRef }) => {
            const [pos, setPos] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            const [isWrong, setIsWrong] = useState(false);
            const itemRef = useRef(null);
            
            // Inisialisasi posisi acak di area atas
            useEffect(() => {
                if(containerRef.current) {
                    const cw = containerRef.current.offsetWidth;
                    const ch = containerRef.current.offsetHeight;
                    // Area spawn: Top 50% of game area
                    setPos({
                        x: Math.random() * (cw - 80),
                        y: Math.random() * (ch * 0.4) 
                    });
                }
            }, [containerRef]); // Reset when component mounts

            const handlePointerDown = (e) => {
                if (isCorrect) return;
                e.preventDefault(); // Prevent scroll
                setIsDragging(true);
                e.target.setPointerCapture(e.pointerId);
            };

            const handlePointerMove = (e) => {
                if (!isDragging) return;
                
                // Update visual position immediately
                const parentRect = containerRef.current.getBoundingClientRect();
                let newX = e.clientX - parentRect.left - 40; // Center anchor
                let newY = e.clientY - parentRect.top - 40;

                // Boundary check
                newX = Math.max(0, Math.min(newX, parentRect.width - 80));
                newY = Math.max(0, Math.min(newY, parentRect.height - 80));

                setPos({ x: newX, y: newY });
            };

            const handlePointerUp = (e) => {
                if (!isDragging) return;
                setIsDragging(false);
                e.target.releasePointerCapture(e.pointerId);

                // Check Drop Collision
                const itemRect = itemRef.current.getBoundingClientRect();
                const itemCenter = { x: itemRect.left + itemRect.width/2, y: itemRect.top + itemRect.height/2 };

                // Find bins
                const bins = document.querySelectorAll('.bin-drop-zone');
                let droppedIn = null;

                bins.forEach(bin => {
                    const binRect = bin.getBoundingClientRect();
                    if (
                        itemCenter.x >= binRect.left &&
                        itemCenter.x <= binRect.right &&
                        itemCenter.y >= binRect.top &&
                        itemCenter.y <= binRect.bottom
                    ) {
                        droppedIn = bin.getAttribute('data-type');
                    }
                });

                if (droppedIn) {
                    if (droppedIn === item.type) {
                        // Correct!
                        setIsCorrect(true);
                        onDrop(item.id, true);
                    } else {
                        // Wrong!
                        setIsWrong(true);
                        speak("Salah tempat!");
                        setTimeout(() => setIsWrong(false), 500);
                    }
                }
            };

            if (isCorrect) return null; // Hide if sorted

            const ShapeComp = Shapes[item.type];

            return (
                <div
                    ref={itemRef}
                    className={`absolute w-20 h-20 draggable-item ${isWrong ? 'shake' : ''} animate-bounce-in`}
                    style={{ left: pos.x, top: pos.y, touchAction: 'none' }}
                    onPointerDown={handlePointerDown}
                    onPointerMove={handlePointerMove}
                    onPointerUp={handlePointerUp}
                >
                    <ShapeComp color={item.color} />
                </div>
            );
        };

        // --- 3. MAIN APP ---

        const App = () => {
            const [screen, setScreen] = useState('start'); // start, playing, finish
            const [levels, setLevels] = useState([]);
            const [currentLevelIdx, setCurrentLevelIdx] = useState(0);
            const [remainingItems, setRemainingItems] = useState(0);
            const containerRef = useRef(null);

            useEffect(() => {
                // Pre-load levels
                setLevels(generateLevels());
            }, []);

            const currentLevel = levels[currentLevelIdx];

            // TTS Instruction
            useEffect(() => {
                if (screen === 'playing' && currentLevel) {
                    setRemainingItems(currentLevel.items.length);
                    speak(currentLevel.instruction);
                }
            }, [screen, currentLevelIdx]);

            const handleStart = () => {
                setLevels(generateLevels()); // Regen fresh levels
                setCurrentLevelIdx(0);
                setScreen('playing');
            };

            const handleItemDrop = (itemId) => {
                speak("Benar!");
                setRemainingItems(prev => {
                    const newVal = prev - 1;
                    if (newVal === 0) {
                        // Level Complete
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        speak("Hebat! Semua sudah rapi.");
                        setTimeout(() => {
                            if (currentLevelIdx < 9) {
                                setCurrentLevelIdx(prev => prev + 1);
                            } else {
                                setScreen('finish');
                                speak("Selamat! Kamu berhasil menyelesaikan semua level.");
                            }
                        }, 2000);
                    }
                    return newVal;
                });
            };

            const getLabel = (type) => {
                if (type === 'persegipanjang') return 'Persegi Panjang';
                return type.charAt(0).toUpperCase() + type.slice(1);
            }

            // --- START SCREEN ---
            if (screen === 'start') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-4 text-center relative">
                        <div className="absolute top-20 left-10 animate-bounce w-24 text-red-500"><Shapes.segitiga color="#ef4444"/></div>
                        <div className="absolute bottom-32 right-10 animate-bounce w-24 text-blue-500" style={{animationDelay: '0.5s'}}><Shapes.lingkaran color="#3b82f6"/></div>
                        
                        <h1 className="text-5xl md:text-6xl font-bold text-teal-600 mb-4 font-title drop-shadow-md">
                            Kelompokkan Bentuk
                        </h1>
                        <p className="text-xl text-gray-600 mb-8">
                            Tarik bentuk ke dalam keranjang yang benar!
                        </p>
                        <button 
                            onClick={handleStart}
                            className="bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 px-16 rounded-full shadow-2xl transform transition hover:scale-105 active:scale-95 border-b-8 border-orange-700"
                        >
                            MULAI
                        </button>
                    </div>
                );
            }

            // --- FINISH SCREEN ---
            if (screen === 'finish') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-4 text-center bg-yellow-50">
                        <div className="text-9xl mb-6 animate-bounce">üèÜ</div>
                        <h1 className="text-5xl font-bold text-orange-600 mb-4 font-title">Luar Biasa!</h1>
                        <p className="text-2xl text-gray-600 mb-8">Kamu sudah jago mengelompokkan bentuk.</p>
                        <button 
                            onClick={handleStart}
                            className="bg-teal-500 hover:bg-teal-600 text-white text-xl font-bold py-3 px-10 rounded-full shadow-lg transform transition hover:scale-105 border-b-8 border-teal-700"
                        >
                            Main Lagi
                        </button>
                        {/* Footer here because main layout wraps game */}
                        <div className="mt-10">
                            <p className="text-gray-500 text-sm font-bold">
                                Dibuat oleh <span className="text-teal-600">Abdul Salim Owner folderosn.com</span>
                            </p>
                            <a href="https://pakabdulsalim.blogspot.com/" target="_blank" className="text-blue-500 text-sm font-bold hover:underline">Kunjungi: https://pakabdulsalim.blogspot.com</a>
                        </div>
                    </div>
                );
            }

            // --- PLAYING SCREEN ---
            return (
                <div className="flex flex-col h-full relative overflow-hidden">
                    
                    {/* Header */}
                    <div className="bg-white/80 p-4 flex justify-between items-center shadow-sm z-10 backdrop-blur-sm">
                        <div className="flex items-center gap-2">
                            <button onClick={() => setScreen('start')} className="text-gray-400 hover:text-gray-600">
                                <i className="fa-solid fa-house text-2xl"></i>
                            </button>
                            <div className="bg-teal-100 px-4 py-1 rounded-full text-teal-700 font-bold border-2 border-teal-200">
                                Level {currentLevelIdx + 1} / 10
                            </div>
                        </div>
                        <h2 className="text-xl md:text-2xl font-bold text-gray-700 hidden md:block">
                            {currentLevel.instruction}
                        </h2>
                        <button onClick={() => speak(currentLevel.instruction)} className="bg-white p-2 rounded-full shadow text-teal-500 hover:text-teal-700">
                            <i className="fa-solid fa-volume-high text-2xl"></i>
                        </button>
                    </div>

                    {/* Game Area */}
                    <div ref={containerRef} className="flex-grow relative w-full bg-teal-50/50">
                        
                        {/* Draggable Items Layer */}
                        {currentLevel.items.map(item => (
                            <DraggableItem 
                                key={item.id} 
                                item={item} 
                                onDrop={handleItemDrop}
                                containerRef={containerRef}
                            />
                        ))}

                        {/* Bins Layer (Bottom) */}
                        <div className="absolute bottom-0 left-0 w-full h-1/2 flex items-end justify-center pb-4 gap-4 px-4 pointer-events-none"> 
                            
                            {currentLevel.bins.map((binType, idx) => {
                                const ShapeIcon = Shapes[binType];
                                return (
                                    <div 
                                        key={idx} 
                                        data-type={binType}
                                        className="bin-drop-zone flex-1 h-48 md:h-64 bg-white/90 backdrop-blur rounded-t-3xl border-4 border-dashed border-teal-300 flex flex-col items-center justify-end pb-4 shadow-xl relative overflow-visible transition-colors"
                                    >
                                        {/* Bin Label & Icon */}
                                        <div className="absolute -top-10 md:-top-16 w-20 h-20 md:w-24 md:h-24 bg-white rounded-full border-4 border-teal-400 p-4 shadow-md flex items-center justify-center animate-bounce">
                                            <ShapeIcon color="#f59e0b" />
                                        </div>
                                        
                                        <div className="text-center mb-2">
                                            <p className="text-gray-400 text-sm font-bold uppercase tracking-wider">Keranjang</p>
                                            <h3 className="text-xl md:text-3xl font-bold text-teal-600 font-title">
                                                {getLabel(binType)}
                                            </h3>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                    </div>

                    {/* FOOTER (Fixed at bottom) */}
                    <footer className="bg-white border-t-4 border-teal-300 py-2 z-20">
                        <div className="container mx-auto text-center">
                            <p className="text-gray-600 text-xs md:text-sm font-bold">
                                Dibuat oleh <span className="text-teal-600">Abdul Salim Owner folderosn.com</span>
                            </p>
                            <a href="https://pakabdulsalim.blogspot.com/" target="_blank" className="inline-block text-blue-500 hover:text-blue-700 font-bold hover:underline transition-all text-xs">
                                Kunjungi: https://pakabdulsalim.blogspot.com
                            </a>
                        </div>
                    </footer>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
